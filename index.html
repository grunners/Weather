<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	</head>

	<body style="font-family: Calibri;">
		
	<form id="weather" action="	">
		<input type="submit" value="Get Forecast">
		<p id="output"></p>
		<img id="loader" src="loader.gif" style="display: none;"/>
	</form>

		<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

		<script type="text/javascript">
			$(function() {

				const ds_key = "f5fcf916bad24f6c6c3a002daffc95dc";
				var postcode = "LS141AB";

				//on form submit
				$('#weather').on('submit', function (e) {
					$('#loader').show();
					$('#output').html("Loading...");
			        if (e.isDefaultPrevented()) {
			            console.log('form is not valid');
			        } 
			        else {
			            e.preventDefault();
			            $.ajax({
			               	url: 'http://api.getthedata.com/postcode/' + postcode,
			                type: 'GET',
			                //valid json response
			                success: function(result) {
			                	console.log("Postcode object:", result);
			                	handlePostcode(result);
			                },
			                //invalid
			                error: function() {
			                	console.log("There was an error retrieving the postcode information");
			                }
			            })
			        }
				});

				//send the coords to the weather api
				function handlePostcode(response) {
					grabWeather(response.data.latitude, response.data.longitude);
				}


				//get data from weather api
				function grabWeather(latitude, longitude) {
					//console.log(latitude + "," + longitude + " " + ds_key);
					var lat_long = latitude + "," + longitude;
					//use cors proxy - build locally when ready
					var weather_url = "http://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + ds_key + "/" + lat_long;

					$.ajax({
						url: weather_url,
						type: 'GET',
						//valid json response
						success: function(result) {
							console.log("Weather object:", result);
							//$('#output').html("It is currently " + result.currently.apparentTemperature + " &#8457; at " + postcode);
							$('#output').html(result.currently.summary);
							$('#loader').hide();
						},
						//invalid
						error: function(result) {
							console.log(result);
							$('#output').html("There was an error retrieving the weather information");
							$('#loader').hide();
						}
					})
				}
			});
		</script>
	</body>
</html>